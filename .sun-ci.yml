workspace: true

stages:
  - build
  - test

jobs:
  - name: prepare
    stage: build
    image: khuonghb/ruby_2.7.1_alpine_3.12:v7
    script:
      - cp config/application-ci.yml config/application.yml
      - bundle _2.1.4_ install
    cache:
      - key: bundle_$CI_BRANCH
        paths:
          - vendor/bundle
      - key: node_modules_$CI_BRANCH
        paths:
          - node_modules

  - name: rubocop
    stage: test
    image: khuonghb/ruby_2.7.1_alpine_3.12:v7
    before_script:
      - bundle _2.1.4_ install
    script:
      - bundle _2.1.4_ exec rubocop

  - name: rspec
    stage: test
    image: khuonghb/ruby_2.7.1_alpine_3.12:v7
    services:
      - image: mysql:5.7
        name: mysql_db
        environment:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_USER: root
          MYSQL_HOST: mysql_db
    environment:
      RAILS_ENV: test
    before_script:
      - bundle _2.1.4_ install
      - bundle exec rails db:drop db:create db:migrate
    script:
      - bundle _2.1.4_ exec rspec
